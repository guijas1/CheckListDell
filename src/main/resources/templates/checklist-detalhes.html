<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Checklist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .editable[contenteditable="true"] {
            border-bottom: 1px dashed #0d6efd;
            cursor: text;
            transition: background-color 0.2s ease-in-out;
        }
        .editable[contenteditable="true"]:focus {
            background-color: #fff;
            outline: none;
        }
        select.form-select {
            max-width: 110px;
            padding: 2px 4px;
            font-size: 0.9rem;
        }
        .disabled-select {
            pointer-events: none;
            opacity: 0.7;
        }
        .list-group-item {
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
            padding-left: 0.9rem;
            padding-right: 0.9rem;
        }
        .list-group-item.d-flex.justify-content-between.align-items-center {
            align-items: center;
            gap: 0.4rem;
        }
        .list-group-item span.fw-bold,
        .list-group-item select.form-select-sm {
            margin-left: auto;
            min-width: 85px;
        }
        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 1.5rem 0;
        }
        h5.mb-3 {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
        }
        h5.mb-3[data-icon="dell"]::before { content: "üíª"; color: #0d6efd; }
        h5.mb-3[data-icon="checklist"]::before { content: "‚úîÔ∏è"; color: #0d6efd; }
        h5.mb-3[data-icon="obs"]::before { content: "üóíÔ∏è"; color: #0d6efd; }
        h5.mt-4[data-icon="foto"]::before { content: "üì∏"; color: #0d6efd; }

        .placeholder-text {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">üìù Detalhes do Checklist</h3>
            <div class="d-flex gap-2">
                <button id="editBtn" class="btn btn-outline-light btn-sm">‚úèÔ∏è Editar Campos</button>
                <a href="/checklists" class="btn btn-outline-light btn-sm">‚Æú Voltar</a>
            </div>
        </div>

        <div class="card-body">
            <form id="updateForm" th:action="@{'/checklists/' + ${checklist.id} + '/atualizar'}" method="post">

                <!-- DADOS PRINCIPAIS -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Modelo:</strong> <span th:text="${checklist.modelo}"></span><br>
                        <strong>Patrim√¥nio:</strong>
                        <span id="patrimonio" class="editable" contenteditable="false" th:text="${checklist.patrimonio}"></span><br>
                        <strong>Localiza√ß√£o:</strong>
                        <span id="localizacao" class="editable" contenteditable="false"
                              th:text="${checklist.localizacao != null ? checklist.localizacao : '‚Äî'}"></span><br>
                        <strong>Sa√∫de da Bateria:</strong>
                        <span id="bateria" class="editable" contenteditable="false"
                              th:text="${checklist.bateria != null ? checklist.bateria : '‚Äî'}"></span><br>
                    </div>
                    <div class="col-md-6">
                        <strong>Service Tag:</strong> <span th:text="${checklist.serviceTag}"></span><br>
                        <strong>Data:</strong> <span th:text="${checklist.dataCriacaoFormatada}"></span><br>
                        <strong>Chamado OTRS:</strong>
                        <span id="chamadoOTRS" class="editable" contenteditable="false"
                              th:text="${checklist.chamadoOTRS}"></span><br>
                        <strong>Origem do Notebook:</strong>
                        <span id="historicoNotebook" class="editable" contenteditable="false"
                              th:text="${checklist.historicoNotebook}"></span><br>
                    </div>
                </div>

                <!-- üíª INFORMA√á√ïES DELL -->
                <div class="section-divider"></div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0" data-icon="dell">Informa√ß√µes Dell</h5>
                    <a th:href="@{'/checklists/' + ${checklist.id} + '/dell'}"
                       class="btn btn-outline-primary btn-sm">üîç Ver Detalhes Dell</a>
                </div>

                <ul class="list-group mb-4">
                    <!-- Chamado Dell -->
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Chamado Dell
                        <span th:if="${#strings.isEmpty(checklist.chamadoDell)}"
                              class="editable fw-bold placeholder-text" contenteditable="false">Sem Registro</span>
                        <span th:unless="${#strings.isEmpty(checklist.chamadoDell)}"
                              id="chamadoDell" class="editable fw-bold" contenteditable="false"
                              th:text="${checklist.chamadoDell}"></span>
                    </li>

                    <!-- Status Chamado Dell -->
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Status Chamado Dell
                        <span th:if="${checklist.statusChamadoDell == T(com.guijas1.checklistDell.Enums.StatusChamadoDell).SEM_CHAMADO}"
                              class="editable fw-bold placeholder-text" contenteditable="false">Sem chamado</span>
                        <span th:unless="${checklist.statusChamadoDell == T(com.guijas1.checklistDell.Enums.StatusChamadoDell).SEM_CHAMADO}"
                              id="statusChamadoDell" class="editable fw-bold" contenteditable="false"
                              th:text="${checklist.statusChamadoDell}"></span>
                    </li>
                </ul>

                <!-- ‚úîÔ∏è RESPOSTAS DO CHECKLIST -->
                <div class="section-divider"></div>
                <h5 class="mb-3" data-icon="checklist">Respostas do Checklist</h5>
                <ul class="list-group mb-4">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Liga normalmente
                        <select id="liga" name="liga" class="form-select form-select-sm disabled-select">
                            <option th:selected="${checklist.liga}" value="true">Sim</option>
                            <option th:selected="${!checklist.liga}" value="false">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tela apresenta imagem
                        <select id="telaFunciona" name="telaFunciona" class="form-select form-select-sm disabled-select">
                            <option th:selected="${checklist.telaFunciona}" value="true">Sim</option>
                            <option th:selected="${!checklist.telaFunciona}" value="false">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Teclado funcionando
                        <select id="tecladoFunciona" name="tecladoFunciona" class="form-select form-select-sm disabled-select">
                            <option th:selected="${checklist.tecladoFunciona}" value="true">Sim</option>
                            <option th:selected="${!checklist.tecladoFunciona}" value="false">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Wi-Fi conecta corretamente
                        <select id="wifiFunciona" name="wifiFunciona" class="form-select form-select-sm disabled-select">
                            <option th:selected="${checklist.wifiFunciona}" value="true">Sim</option>
                            <option th:selected="${!checklist.wifiFunciona}" value="false">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Carca√ßa sem avarias
                        <select id="carcaca" name="carcaca" class="form-select form-select-sm disabled-select">
                            <option th:selected="${checklist.carcaca}" value="true">Sim</option>
                            <option th:selected="${!checklist.carcaca}" value="false">N√£o</option>
                        </select>
                    </li>
                </ul>

                <!-- OBSERVA√á√ïES -->
                <div class="section-divider"></div>
                <h5 class="mb-3" data-icon="obs">Observa√ß√µes</h5>
                <p id="observacoes" class="editable border rounded p-2 bg-white" contenteditable="false"
                   th:text="${checklist.observacoes ?: 'Sem observa√ß√µes.'}"></p>

                <div class="text-end mt-3">
                    <button id="saveBtn" type="submit" class="btn btn-outline-success d-none">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>

            <!-- üì∏ FOTOS -->
            <div class="section-divider"></div>
            <h5 class="mt-4" data-icon="foto">Fotos Anexadas</h5>

            <div th:if="${checklist.fotoPath != null and !checklist.fotoPath.isEmpty()}">
                <div class="d-flex flex-wrap gap-3 mt-2">
                    <div th:each="foto, iterStat : ${checklist.fotoPath}">
                        <img th:src="${foto}" th:attr="data-index=${iterStat.index}"
                             class="img-thumbnail shadow-sm gallery-photo"
                             style="max-width: 200px; cursor: pointer;">
                    </div>
                </div>
            </div>

            <div th:if="${checklist.fotoPath == null or checklist.fotoPath.isEmpty()}" class="text-muted mt-2">
                Nenhuma imagem foi anexada.
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <a th:href="@{'/checklists/' + ${checklist.id} + '/exportar'}" class="btn btn-outline-primary">üìÑ Exportar PDF</a>
                <form th:action="@{'/checklists/' + ${checklist.id} + '/deletar'}" method="post"
                      onsubmit="return confirm('Tem certeza que deseja excluir este checklist?');">
                    <button type="submit" class="btn btn-outline-danger">üóëÔ∏è Excluir Checklist</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE FOTOS -->
<div class="modal fade" id="galleryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-0">
            <div class="modal-body text-center p-0">
                <img id="galleryImage" class="img-fluid rounded" src="" alt="Foto ampliada">
            </div>
            <div class="modal-footer bg-dark border-0 justify-content-between">
                <button id="prevBtn" class="btn btn-outline-light btn-sm">‚Üê Anterior</button>
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
                <button id="nextBtn" class="btn btn-outline-light btn-sm">Pr√≥xima ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const editables = document.querySelectorAll(".editable");
    const selects = document.querySelectorAll("select");
    const form = document.getElementById("updateForm");

    editBtn.addEventListener("click", () => {
        const editing = editBtn.classList.toggle("btn-warning");
        editables.forEach(e => e.contentEditable = editing);
        selects.forEach(s => s.classList.toggle("disabled-select", !editing));
        saveBtn.classList.toggle("d-none", !editing);
        editBtn.textContent = editing ? "üîí Bloquear Edi√ß√£o" : "‚úèÔ∏è Editar Campos";
    });

    form.addEventListener("submit", function() {
        editables.forEach(e => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = e.id;
            input.value = e.innerText.trim();
            this.appendChild(input);
        });
    });

    // GALERIA DE FOTOS
    const galleryModal = new bootstrap.Modal(document.getElementById('galleryModal'));
    const galleryPhotos = document.querySelectorAll('.gallery-photo');
    const galleryImage = document.getElementById('galleryImage');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let currentIndex = 0;
    let photos = [];

    galleryPhotos.forEach((photo, index) => {
        photos.push(photo.src);
        photo.addEventListener('click', () => {
            currentIndex = index;
            openImage(currentIndex);
            galleryModal.show();
        });
    });

    function openImage(index) {
        if (index < 0) index = photos.length - 1;
        if (index >= photos.length) index = 0;
        galleryImage.src = photos[index];
        currentIndex = index;
    }

    prevBtn.addEventListener('click', () => openImage(currentIndex - 1));
    nextBtn.addEventListener('click', () => openImage(currentIndex + 1));

    document.addEventListener('keydown', (e) => {
        if (!document.getElementById('galleryModal').classList.contains('show')) return;
        if (e.key === 'ArrowLeft') openImage(currentIndex - 1);
        if (e.key === 'ArrowRight') openImage(currentIndex + 1);
    });
</script>
</body>
</html>
