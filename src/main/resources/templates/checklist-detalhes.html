<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Checklist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .editable[contenteditable="true"] {
          border-bottom: 1px dashed #0d6efd;
          cursor: text;
          transition: background-color 0.2s ease-in-out;
        }
        .editable[contenteditable="true"]:focus { background-color: #fff; outline: none; }

        select.form-select-sm { max-width: 200px; padding: 2px 4px; font-size: 0.9rem; }
        .disabled-select { pointer-events: none; opacity: 0.7; }
        .list-group-item { padding: 0.3rem 0.9rem; }

        h5[data-icon]::before {
          margin-right: 0.4rem;
          color: #0d6efd;
        }
        h5[data-icon="func"]::before { content: "üíª"; }
        h5[data-icon="estrut"]::before { content: "üî©"; }
        h5[data-icon="tela"]::before { content: "üñ•Ô∏è"; }
        h5[data-icon="som"]::before { content: "üé§"; }
        h5[data-icon="cham"]::before { content: "üóÉÔ∏è"; }
        h5[data-icon="orig"]::before { content: "üì¶"; }
        h5[data-icon="obs"]::before { content: "üóíÔ∏è"; }
        h5[data-icon="foto"]::before { content: "üì∏"; }

        .section-divider { border-top: 1px solid #dee2e6; margin: 1.5rem 0; }
        .gallery-photo {
          max-width: 200px;
          cursor: pointer;
          border-radius: 6px;
          transition: transform 0.2s ease-in-out;
        }
        .gallery-photo:hover { transform: scale(1.05); }
        .modal-dialog-centered img {
          max-width: 100%;
          max-height: 80vh;
          transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="bg-light">

<div class="container my-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">üìù Detalhes do Checklist</h3>
            <div class="d-flex gap-2">
                <button id="editBtn" class="btn btn-outline-light btn-sm">‚úèÔ∏è Editar Campos</button>
                <a href="/checklists" class="btn btn-outline-light btn-sm">‚Æú Voltar</a>
            </div>
        </div>

        <div class="card-body">
            <form id="updateForm" th:action="@{'/checklists/' + ${checklist.id} + '/atualizar'}" method="post">

                <!-- üîπ Dados principais -->
                <div class="row mb-3 position-relative">
                    <div class="col-md-6">
                        <strong>Modelo:</strong> <span th:text="${checklist.modelo}"></span><br>
                        <strong>Patrim√¥nio:</strong> <span id="patrimonio" class="editable" contenteditable="false" th:text="${checklist.patrimonio}"></span><br>
                        <strong>Localiza√ß√£o:</strong> <span id="localizacao" class="editable" contenteditable="false" th:text="${checklist.localizacao}"></span><br>
                        <strong>Sa√∫de da Bateria:</strong> <span id="bateria" class="editable" contenteditable="false" th:text="${checklist.bateria}"></span><br>

                        <!-- üîÑ De ‚Üí Para (edit√°vel) -->
                        <strong>De ‚Üí Para:</strong>
                        <span id="depara" class="editable" contenteditable="false"
                              th:text="${checklist.depara != null ? checklist.depara : ''}"></span><br>
                    </div>

                    <div class="col-md-6 position-relative">
                        <strong>Service Tag:</strong> <span th:text="${checklist.serviceTag}"></span><br>
                        <strong>Data:</strong> <span th:text="${checklist.dataCriacaoFormatada}"></span><br>
                        <strong>Chamado OTRS:</strong> <span id="chamadoOTRS" class="editable" contenteditable="false" th:text="${checklist.chamadoOTRS}"></span><br>
                        <strong>Origem do Notebook:</strong> <span id="historicoNotebook" class="editable" contenteditable="false" th:text="${checklist.historicoNotebook}"></span><br>

                        <!-- üè∑Ô∏è TAG (drop-down obrigat√≥rio no canto superior direito) -->
                        <div style="position:absolute; top:0; right:0; text-align:right;">
                            <select id="tag" name="tag" required
                                    class="form-select form-select-sm disabled-select"
                                    style="display:inline-block; width:auto; min-width:180px;">
                                <!-- placeholder desabilitado: for√ßa sele√ß√£o -->
                                <option value="" disabled th:selected="${checklist.tag} == null">‚Äî selecione a TAG ‚Äî</option>

                                <!-- op√ß√µes do Enum, com r√≥tulo amig√°vel -->
                                <option th:each="t : ${tags}"
                                        th:value="${t.name()}"
                                        th:text="${t.label} + ' (' + ${t.name()} + ')'"
                                        th:selected="${checklist.tag} == ${t}">
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- üíª Funcionamento -->
                <div class="section-divider"></div>
                <h5 data-icon="func">Funcionamento Geral</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">Liga normalmente
                        <select id="liga" name="liga" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.liga == true}">Sim</option>
                            <option value="0" th:selected="${checklist.liga != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Tela funciona
                        <select id="telaFunciona" name="telaFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.telaFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.telaFunciona != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Teclado funciona
                        <select id="tecladoFunciona" name="tecladoFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.tecladoFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.tecladoFunciona != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Wi-Fi funciona
                        <select id="wifiFunciona" name="wifiFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.wifiFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.wifiFunciona != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Carca√ßa sem avarias
                        <select id="carcaca" name="carcaca" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.carcaca == true}">Sim</option>
                            <option value="0" th:selected="${checklist.carcaca != true}">N√£o</option>
                        </select>
                    </li>
                </ul>

                <!-- üî© Estrutura F√≠sica -->
                <div class="section-divider"></div>
                <h5 data-icon="estrut">Estrutura F√≠sica</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Borracha de prote√ß√£o OK?
                        <select id="borrachaProtecaoOk" name="borrachaProtecaoOk" class="form-select form-select-sm disabled-select"
                                onchange="toggleExtra('borrachaProtecaoOk','borrachaProtecaoFaltantesDiv')">
                            <option value="1" th:selected="${checklist.borrachaProtecaoOk == true}">Sim</option>
                            <option value="0" th:selected="${checklist.borrachaProtecaoOk != true}">N√£o</option>
                        </select>
                    </li>
                    <li id="borrachaProtecaoFaltantesDiv" class="list-group-item" style="display:none;">
                        <label>Faltantes:</label>
                        <input id="borrachaProtecaoFaltantes" name="borrachaProtecaoFaltantes" type="number" class="form-control form-control-sm"
                               th:value="${checklist.borrachaProtecaoFaltantes}">
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Parafusos OK?
                        <select id="parafusosOk" name="parafusosOk" class="form-select form-select-sm disabled-select"
                                onchange="toggleExtra('parafusosOk','parafusosFaltantesDiv')">
                            <option value="1" th:selected="${checklist.parafusosOk == true}">Sim</option>
                            <option value="0" th:selected="${checklist.parafusosOk != true}">N√£o</option>
                        </select>
                    </li>
                    <li id="parafusosFaltantesDiv" class="list-group-item" style="display:none;">
                        <label>Faltantes:</label>
                        <input id="parafusosFaltantes" name="parafusosFaltantes" type="number" class="form-control form-control-sm"
                               th:value="${checklist.parafusosFaltantes}">
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tampa inferior OK?
                        <select id="tampaInferiorOk" name="tampaInferiorOk" class="form-select form-select-sm disabled-select"
                                onchange="toggleExtra('tampaInferiorOk','tampaInferiorFaltantesDiv')">
                            <option value="1" th:selected="${checklist.tampaInferiorOk == true}">Sim</option>
                            <option value="0" th:selected="${checklist.tampaInferiorOk != true}">N√£o</option>
                        </select>
                    </li>
                    <li id="tampaInferiorFaltantesDiv" class="list-group-item" style="display:none;">
                        <label>Faltantes:</label>
                        <input id="tampaInferiorFaltantes" name="tampaInferiorFaltantes" type="number" class="form-control form-control-sm"
                               th:value="${checklist.tampaInferiorFaltantes}">
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Portas funcionando?
                        <select id="portasFuncionando" name="portasFuncionando" class="form-select form-select-sm disabled-select"
                                onchange="toggleExtra('portasFuncionando','portasDescricaoDiv')">
                            <option value="1" th:selected="${checklist.portasFuncionando == true}">Sim</option>
                            <option value="0" th:selected="${checklist.portasFuncionando != true}">N√£o</option>
                        </select>
                    </li>
                    <li id="portasDescricaoDiv" class="list-group-item" style="display:none;">
                        <label>Descreva as portas com problema:</label>
                        <textarea id="portasDescricao" name="portasDescricao" class="form-control form-control-sm" rows="2"
                                  th:text="${checklist.portasDescricao}"></textarea>
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Dobradi√ßas OK?
                        <select id="dobradicasOk" name="dobradicasOk" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.dobradicasOk == true}">Sim</option>
                            <option value="0" th:selected="${checklist.dobradicasOk != true}">N√£o</option>
                        </select>
                    </li>
                </ul>

                <!-- üé§ Som -->
                <div class="section-divider"></div>
                <h5 data-icon="som">Som e Perif√©ricos</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">C√¢mera funciona
                        <select id="cameraFunciona" name="cameraFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.cameraFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.cameraFunciona != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Microfone funciona
                        <select id="microfoneFunciona" name="microfoneFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.microfoneFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.microfoneFunciona != true}">N√£o</option>
                        </select>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Alto-falante funciona
                        <select id="altoFalanteFunciona" name="altoFalanteFunciona" class="form-select form-select-sm disabled-select">
                            <option value="1" th:selected="${checklist.altoFalanteFunciona == true}">Sim</option>
                            <option value="0" th:selected="${checklist.altoFalanteFunciona != true}">N√£o</option>
                        </select>
                    </li>
                </ul>

                <!-- üóÉÔ∏è Chamados -->
                <div class="section-divider"></div>
                <h5 data-icon="cham">Chamados e Status</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Chamado Dell <span th:text="${checklist.chamadoDell != null ? checklist.chamadoDell : '‚Äî'}"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Status Dell <span th:text="${checklist.statusChamadoDell != null ? checklist.statusChamadoDell : '‚Äî'}"></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Status Interno <span th:text="${checklist.statusInterno != null ? checklist.statusInterno : '‚Äî'}"></span>
                    </li>
                </ul>

                <!-- üîó Bot√£o Dell -->
                <div class="text-end mb-4">
                    <a th:href="@{'/checklists/' + ${checklist.id} + '/dell'}" class="btn btn-outline-primary btn-sm">
                        ‚öôÔ∏è Ver Informa√ß√µes Dell
                    </a>
                </div>

                <!-- üóíÔ∏è Observa√ß√µes -->
                <div class="section-divider"></div>
                <h5 data-icon="obs">Observa√ß√µes</h5>
                <p id="observacoes" class="editable border rounded p-2 bg-white" contenteditable="false"
                   th:text="${checklist.observacoes != null ? checklist.observacoes : 'Sem observa√ß√µes.'}"></p>

                <div class="text-end mt-3">
                    <button id="saveBtn" type="submit" class="btn btn-outline-success d-none">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>

            <!-- üì∏ FOTOS -->
            <div class="section-divider"></div>
            <h5 data-icon="foto">Fotos Anexadas</h5>
            <div th:if="${checklist.fotoPath != null and !checklist.fotoPath.isEmpty()}">
                <div class="d-flex flex-wrap gap-3 mt-2">
                    <div th:each="foto, iter : ${checklist.fotoPath}">
                        <img th:src="${foto}" th:data-index="${iter.index}" class="img-thumbnail shadow-sm gallery-photo"
                             onclick="openModal(this)">
                    </div>
                </div>
            </div>
            <div th:if="${checklist.fotoPath == null or checklist.fotoPath.isEmpty()}" class="text-muted mt-2">
                Nenhuma imagem foi anexada.
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <a th:href="@{'/checklists/' + ${checklist.id} + '/exportar'}" class="btn btn-outline-primary">üìÑ Exportar PDF</a>
                <form th:action="@{'/checklists/' + ${checklist.id} + '/deletar'}" method="post"
                      onsubmit="return confirm('Tem certeza que deseja excluir este checklist?');">
                    <button type="submit" class="btn btn-outline-danger">üóëÔ∏è Excluir Checklist</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- üì∏ Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-body text-center p-0 position-relative">
                <img id="modalImage" src="" alt="Foto ampliada" class="img-fluid">
                <button class="btn btn-outline-light position-absolute top-50 start-0 translate-middle-y"
                        onclick="prevPhoto()">‚Æú</button>
                <button class="btn btn-outline-light position-absolute top-50 end-0 translate-middle-y"
                        onclick="nextPhoto()">‚Æû</button>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-outline-light btn-sm" onclick="zoomIn()">üîç+</button>
                <button class="btn btn-outline-light btn-sm" onclick="zoomOut()">üîç‚àí</button>
                <button class="btn btn-outline-danger btn-sm" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const editables = document.querySelectorAll(".editable");
    const selects = document.querySelectorAll("select");
    const form = document.getElementById("updateForm");

    // Alterna modo de edi√ß√£o
    editBtn.addEventListener("click", () => {
      const editing = editBtn.classList.toggle("btn-warning");
      editables.forEach(e => e.contentEditable = editing);
      selects.forEach(s => s.classList.toggle("disabled-select", !editing));
      saveBtn.classList.toggle("d-none", !editing);
      editBtn.textContent = editing ? "üîí Bloquear Edi√ß√£o" : "‚úèÔ∏è Editar Campos";
    });

    // Envia valores dos .editable como inputs ocultos
    form.addEventListener("submit", function() {
      editables.forEach(e => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = e.id;
        input.value = (e.innerText || "").trim();
        this.appendChild(input);
      });
    });

    // Exibe/esconde campos extras conforme sele√ß√£o
    function toggleExtra(selectId, divId) {
      const sel = document.getElementById(selectId);
      const div = document.getElementById(divId);
      if (!sel || !div) return;
      div.style.display = (sel.value === "0") ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", () => {
      toggleExtra("borrachaProtecaoOk", "borrachaProtecaoFaltantesDiv");
      toggleExtra("parafusosOk", "parafusosFaltantesDiv");
      toggleExtra("tampaInferiorOk", "tampaInferiorFaltantesDiv");
      toggleExtra("portasFuncionando", "portasDescricaoDiv");
    });

    // üì∏ Modal e Navega√ß√£o
    let fotos = [];
    let currentIndex = 0;
    let zoomLevel = 1;
    const modalImg = document.getElementById("modalImage");
    const imageModal = new bootstrap.Modal(document.getElementById("imageModal"));

    function openModal(img) {
      fotos = Array.from(document.querySelectorAll(".gallery-photo"));
      currentIndex = parseInt(img.dataset.index);
      modalImg.src = img.src;
      zoomLevel = 1;
      modalImg.style.transform = "scale(1)";
      imageModal.show();
    }

    function nextPhoto() {
      if (fotos.length > 0) {
        currentIndex = (currentIndex + 1) % fotos.length;
        modalImg.src = fotos[currentIndex].src;
        resetZoom();
      }
    }

    function prevPhoto() {
      if (fotos.length > 0) {
        currentIndex = (currentIndex - 1 + fotos.length) % fotos.length;
        modalImg.src = fotos[currentIndex].src;
        resetZoom();
      }
    }

    function zoomIn() {
      zoomLevel += 0.2;
      modalImg.style.transform = `scale(${zoomLevel})`;
    }

    function zoomOut() {
      zoomLevel = Math.max(0.6, zoomLevel - 0.2);
      modalImg.style.transform = `scale(${zoomLevel})`;
    }

    function resetZoom() {
      zoomLevel = 1;
      modalImg.style.transform = "scale(1)";
    }

    // üéπ Navega√ß√£o por teclado no modal
    document.addEventListener("keydown", (e) => {
      if (document.getElementById("imageModal").classList.contains("show")) {
        if (e.key === "ArrowRight") nextPhoto();
        if (e.key === "ArrowLeft") prevPhoto();
      }
    });

    // üì± Swipe no celular
    let startX = 0;
    modalImg.addEventListener("touchstart", e => startX = e.touches[0].clientX);
    modalImg.addEventListener("touchend", e => {
      const endX = e.changedTouches[0].clientX;
      if (startX - endX > 50) nextPhoto();
      else if (endX - startX > 50) prevPhoto();
    });
</script>
</body>
</html>
